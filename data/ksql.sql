
-- 1. 전처리; 데비지움 스키마 제거 및 평탄화, 스키마 정의
CREATE STREAM ARTICLE_RAW (
  BEFORE STRUCT<
    ID BIGINT,
    CONTENTS STRING,
    TITLE STRING,
    STATUS STRING
  >,
  AFTER STRUCT<
    ID BIGINT,
    CREATED_AT BIGINT,
    UPDATED_AT BIGINT,
    CONTENTS STRING,
    THUMBNAIL_URL STRING,
    TITLE STRING,
    AUTHOR_ID BIGINT,
    CATEGORY_ID BIGINT,
    HIT INTEGER,
    MEMO_REF_ID BIGINT,
    STATUS STRING,
    DRAFT_CONTENTS STRING,
    DRAFT_THUMBNAIL_URL STRING,
    DRAFT_TITLE STRING
  >,
  OP STRING,
  TS_MS BIGINT
)
WITH (
  KAFKA_TOPIC = 'cdc.jiniaslog_blog.Article',
  VALUE_FORMAT = 'JSON',
  KEY_FORMAT = 'KAFKA'
);


-- 2. 데이터 가공 및 필터링; published 데이터가 변경될때만 처리
CREATE STREAM ARTICLE_CHANGED
WITH (
  KAFKA_TOPIC = 'ARTICLE_CHANGED'
) AS
SELECT
    A.AFTER->ID             AS ID,
    A.AFTER->CREATED_AT     AS CREATED_AT,
    A.AFTER->UPDATED_AT     AS UPDATED_AT,
    A.AFTER->CONTENTS       AS CONTENTS,
    A.AFTER->THUMBNAIL_URL  AS THUMBNAIL_URL,
    A.AFTER->TITLE          AS TITLE,
    A.AFTER->STATUS         AS STATUS
FROM ARTICLE_RAW A
WHERE
    A.OP = 'u' AND (
    A.BEFORE->CONTENTS IS DISTINCT FROM A.AFTER->CONTENTS OR
        A.BEFORE->TITLE IS DISTINCT FROM A.AFTER->TITLE OR
        A.BEFORE->STATUS IS DISTINCT FROM A.AFTER->STATUS
    )
    EMIT CHANGES;