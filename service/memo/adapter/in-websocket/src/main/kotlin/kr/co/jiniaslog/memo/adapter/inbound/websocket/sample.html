<!DOCTYPE html>
<html>
<head>
    <title>Memo WebSocket Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<input type="text" id="authorId" placeholder="Author ID"><br>
<textarea id="memoTitle" placeholder="Memo Title"></textarea><br>
<textarea id="memoContent" placeholder="Memo Content" oninput="initMemo();"></textarea><br>
<div id="recommendations"></div>
<button onclick="getRecommendations()">Get Recommendations</button>
<br> <!-- 추천 버튼 추가 -->
<input type="text" id="tags" placeholder="Tags (comma-separated)"><br>
<button onclick="addTag()">Add Tag</button>
<button onclick="commitMemo()">Commit Memo</button> <!-- 커밋 버튼 추가 -->

<script type="text/javascript">
    var stompClient = null;
    var memoId = null;
    var relatedMemoIds = []; // 연관된 메모 ID 저장을 위한 배열
    window.onload = function () {
        connect();
    };

    function connect() {
        var socket = new SockJS('http://localhost:7777/memo');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/memoResponse', function (response) {
                console.log(response.body)
                handleServerResponse(JSON.parse(response.body));
            });
        });
    }


    function initMemo() {
        if (memoId === null) {
            var command = {
                type: "InitMemo",
                authorId: document.getElementById("authorId").value,
                content: document.getElementById("memoContent").value
            };
            stompClient.send("/app/initMemo", {}, JSON.stringify(command));
            memoId = "pending"; // 초기화 요청을 보냈다는 표시를 위해 임시 값 설정
        }
    }

    function getRecommendations() {
        var command = {
            type: "GetRecommendRelatedMemo",
            query: document.getElementById("memoContent").value
        };
        stompClient.send("/app/getRecommendRelatedMemo", {}, JSON.stringify(command));
    }

    function displayRecommendations(candidates) {
        var recommendationsDiv = document.getElementById("recommendations");
        recommendationsDiv.innerHTML = '';
        candidates.forEach(function (candidate) {
            var div = document.createElement("div");
            div.innerHTML = candidate.second; // MemoTitle
            div.onclick = function () {
                addRelatedMemo(candidate.first);
            }
            recommendationsDiv.appendChild(div);
        });
    }

    function addRelatedMemo(memoId) {
        if (!relatedMemoIds.includes(memoId)) {
            relatedMemoIds.push(memoId);
            console.log("Related memo added: " + memoId);
        }
    }

    function addTag() {
        var tags = document.getElementById("tags").value.split(',');
        console.log("Tags added: " + tags);
        // Add logic to handle tags
    }

    function commitMemo() {
        var command = {
            type: "CommitMemo",
            id: memoId,
            content: document.getElementById("memoContent").value,
            title: document.getElementById("memoTitle").value,
            authorId: document.getElementById("authorId").value,
            links: relatedMemoIds,
        };
        stompClient.send("/app/commitMemo", {}, JSON.stringify(command));

        resetState();
    }

    function resetState() {
        // 상태 초기화
        memoId = null;
        relatedMemoIds = [];
        document.getElementById("memoTitle").value = '';
        document.getElementById("memoContent").value = '';
        document.getElementById("tags").value = '';
        document.getElementById("recommendations").innerHTML = '';
    }

    function handleServerResponse(response) {
        if (response.type === "InitMemoInfo") {
            console.log(response)
            memoId = response.id;
        } else if (response.type === "GetRecommendRelatedMemoInfo") {
            console.log(response)
            displayRecommendations(response.relatedMemoCandidates);
        }
    }
</script>
</body>
</html>
